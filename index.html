<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pill Dispenser Settings - Smart Medication Management</title>
    <meta name="description" content="Configure your automated pill dispenser with scheduled medication times and Telegram notifications">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f0fdfa 0%, #e0f2f1 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
            color: #134e4a;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .icon-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(0, 121, 107, 0.1);
            margin-bottom: 1rem;
        }

        .icon-circle svg {
            width: 32px;
            height: 32px;
            stroke: #00796b;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #134e4a;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.125rem;
            color: #64748b;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 121, 107, 0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 121, 107, 0.12);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .card-header svg {
            width: 20px;
            height: 20px;
            stroke: #00796b;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #134e4a;
        }

        .card-description {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-weight: 600;
            font-size: 0.875rem;
            color: #134e4a;
            display: block;
        }

        input {
            padding: 0.75rem 1rem;
            border: 2px solid #ccfbf1;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
            color: #134e4a;
        }

        input:focus {
            outline: none;
            border-color: #00796b;
            box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.1);
            transform: scale(1.01);
        }

        input[type="number"] {
            appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }

        .save-button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 2rem auto 0;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #00796b, #26a69a);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 121, 107, 0.2);
        }

        .save-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 121, 107, 0.3);
            opacity: 0.9;
        }

        .save-button:active {
            transform: scale(0.98);
        }

        .save-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-size: 1.25rem;
            font-weight: 600;
            color: #00796b;
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 121, 107, 0.3);
            border-top-color: #00796b;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .card:nth-child(1) {
            animation: slideInLeft 0.6s ease-out 0.1s backwards;
        }

        .card:nth-child(2) {
            animation: slideInRight 0.6s ease-out 0.3s backwards;
        }

        .info-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0, 121, 107, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            color: #00796b;
            font-weight: 500;
            margin-bottom: 1rem;
            border: 1px solid rgba(0, 121, 107, 0.2);
        }

        .info-badge svg {
            width: 16px;
            height: 16px;
            stroke: #00796b;
            fill: none;
            stroke-width: 2;
        }

        .time-slot {
            position: relative;
            padding: 1rem;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.03), rgba(38, 166, 154, 0.03));
            border: 1px solid rgba(0, 121, 107, 0.1);
            transition: all 0.3s ease;
        }

        .time-slot:hover {
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.08), rgba(38, 166, 154, 0.08));
            border-color: rgba(0, 121, 107, 0.3);
            transform: translateY(-2px);
        }

        .time-slot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00796b, #26a69a);
            border-radius: 8px 8px 0 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .time-slot:hover::before {
            opacity: 1;
        }

        .slot-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.75rem;
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.1), rgba(38, 166, 154, 0.15));
            transition: all 0.3s ease;
        }

        .time-slot:hover .slot-icon {
            transform: scale(1.1) rotate(5deg);
            background: linear-gradient(135deg, rgba(0, 121, 107, 0.2), rgba(38, 166, 154, 0.25));
        }

        .slot-icon svg {
            width: 20px;
            height: 20px;
            stroke: #00796b;
            fill: none;
            stroke-width: 2;
        }

        .slot-label {
            text-align: center;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .duration-input-wrapper {
            position: relative;
        }

        .duration-input-wrapper::after {
            content: 'ms';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
            pointer-events: none;
        }

        .duration-input-wrapper input {
            padding-right: 0rem;
        }

        .tip-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1.5rem;
            display: flex;
            gap: 0.75rem;
            animation: fadeIn 0.6s ease-out 0.6s backwards;
        }

        .tip-box svg {
            width: 20px;
            height: 20px;
            stroke: #10b981;
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .tip-box-content {
            flex: 1;
        }

        .tip-box-title {
            font-weight: 600;
            color: #059669;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .tip-box-text {
            font-size: 0.875rem;
            color: #047857;
            line-height: 1.5;
        }

        @media (max-width: 640px) {
            body {
                padding: 1rem 0.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .card {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .toast {
                right: 1rem;
                left: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <span class="loading-spinner"></span>
        Loading settings...
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="header">
            <div class="icon-circle">
                <svg viewBox="0 0 24 24">
                    <path d="M10.5 20.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9Z"/>
                    <path d="M17.5 12.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9Z"/>
                </svg>
            </div>
            <h1>Pill Dispenser Settings</h1>
            <p class="subtitle">Configure your automated medication schedule</p>
        </div>

        <div class="card">
            <div class="card-header">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <h2 class="card-title">Medication Schedule</h2>
            </div>
            <p class="card-description">Set your daily medication times using 24-hour format (HH:MM)</p>
            
            <div class="info-badge">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                Your pill dispenser will automatically dispense medication at these times
            </div>

            <div class="form-grid">
                <div class="time-slot">
                    <div class="slot-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        </svg>
                    </div>
                    <div class="slot-label">Morning Dose</div>
                    <div class="form-group">
                        <label for="morningTime">Time</label>
                        <input type="time" id="morningTime">
                    </div>
                </div>
                <div class="time-slot">
                    <div class="slot-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                        </svg>
                    </div>
                    <div class="slot-label">Evening Dose</div>
                    <div class="form-group">
                        <label for="eveningTime">Time</label>
                        <input type="time" id="eveningTime">
                    </div>
                </div>
                <div class="time-slot">
                    <div class="slot-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                    <div class="slot-label">Night Dose</div>
                    <div class="form-group">
                        <label for="nightTime">Time</label>
                        <input type="time" id="nightTime">
                    </div>
                </div>
            </div>

            <div class="tip-box">
                <svg viewBox="0 0 24 24">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <div class="tip-box-content">
                    <div class="tip-box-title">Pro Tip</div>
                    <div class="tip-box-text">Space your medication times at least 4-6 hours apart for optimal effectiveness. Consult your healthcare provider for personalized timing.</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <svg viewBox="0 0 24 24">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                <h2 class="card-title">Dispense Durations</h2>
            </div>
            <p class="card-description">Control how long the motor runs to dispense each dose (in milliseconds)</p>
            
            <div class="info-badge">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="16" x2="12" y2="12"/>
                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                Adjust duration based on pill size and quantity per dose
            </div>

            <div class="form-grid">
                <div class="time-slot">
                    <div class="slot-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        </svg>
                    </div>
                    <div class="slot-label">Morning Duration</div>
                    <div class="form-group">
                        <label for="morningDuration">Milliseconds</label>
                        <div class="duration-input-wrapper">
                            <input type="number" id="morningDuration" min="0" step="100" placeholder="1000">
                        </div>
                    </div>
                </div>
                <div class="time-slot">
                    <div class="slot-icon">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                        </svg>
                    </div>
                    <div class="slot-label">Evening Duration</div>
                    <div class="form-group">
                        <label for="eveningDuration">Milliseconds</label>
                        <div class="duration-input-wrapper">
                            <input type="number" id="eveningDuration" min="0" step="100" placeholder="1000">
                        </div>
                    </div>
                </div>
                <div class="time-slot">
                    <div class="slot-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                    </div>
                    <div class="slot-label">Night Duration</div>
                    <div class="form-group">
                        <label for="nightDuration">Milliseconds</label>
                        <div class="duration-input-wrapper">
                            <input type="number" id="nightDuration" min="0" step="100" placeholder="1000">
                        </div>
                    </div>
                </div>
            </div>

            <div class="tip-box">
                <svg viewBox="0 0 24 24">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <div class="tip-box-content">
                    <div class="tip-box-title">Calibration Tip</div>
                    <div class="tip-box-text">Start with 1000ms (1 second) and adjust based on testing. Increase duration if pills aren't dispensing fully, decrease if too many are dispensed.</div>
                </div>
            </div>
        </div>

        <button class="save-button" onclick="saveData()">
            Save to Firebase
        </button>
    </div>

    <div id="toast" class="toast">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
        </svg>
        <div>
            <div style="font-weight: 700;">Settings saved successfully!</div>
            <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 2px;">Your pill dispenser has been updated.</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBAppkpiENR7RyqfSVW5ZNLhHKwg8zGwfs",
            authDomain: "esp32-cam-python.firebaseapp.com",
            databaseURL: "https://esp32-cam-python-default-rtdb.firebaseio.com",
            projectId: "esp32-cam-python",
            storageBucket: "esp32-cam-python.firebasestorage.app",
            messagingSenderId: "660591571409",
            appId: "1:660591571409:web:dabc298c8bf408a5cbb0f0",
            measurementId: "G-1C5QL57K4W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const pillRef = ref(db, 'PILL_DIPENSER_APP');

        async function loadData() {
            try {
                const snapshot = await get(pillRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('morningTime').value = data.pillTimes.morning || '08:00';
                    document.getElementById('eveningTime').value = data.pillTimes.evening || '14:00';
                    document.getElementById('nightTime').value = data.pillTimes.night || '20:00';
                    document.getElementById('morningDuration').value = data.durations.morning || 1000;
                    document.getElementById('eveningDuration').value = data.durations.evening || 1000;
                    document.getElementById('nightDuration').value = data.durations.night || 1000;
                }
            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
            }
        }

        async function saveData() {
            const button = document.querySelector('.save-button');
            button.disabled = true;
            button.textContent = 'Saving...';

            try {
                const morningTime = document.getElementById('morningTime').value;
                const eveningTime = document.getElementById('eveningTime').value;
                const nightTime = document.getElementById('nightTime').value;
                const morningDuration = parseInt(document.getElementById('morningDuration').value);
                const eveningDuration = parseInt(document.getElementById('eveningDuration').value);
                const nightDuration = parseInt(document.getElementById('nightDuration').value);

                // Get existing telegram data if it exists, or use empty string
                const snapshot = await get(pillRef);
                const existingChatId = snapshot.exists() && snapshot.val().telegram ? snapshot.val().telegram.chat_id : '';

                await set(pillRef, {
                    telegram: { chat_id: existingChatId },
                    pillTimes: { morning: morningTime, evening: eveningTime, night: nightTime },
                    durations: { morning: morningDuration, evening: eveningDuration, night: nightDuration }
                });

                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Failed to save settings. Please try again.');
            } finally {
                button.disabled = false;
                button.textContent = 'Save to Firebase';
            }
        }

        window.saveData = saveData;
        window.onload = loadData;
    </script>
</body>
</html>
